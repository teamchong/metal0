<!DOCTYPE html>
<html>
<head>
    <title>Tokenizer WASM Benchmark</title>
    <style>
        body { font-family: monospace; padding: 20px; max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; }
        .results { margin: 20px 0; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }
        .winner { background-color: #d4edda; font-weight: bold; }
        .loading { color: #666; font-style: italic; }
        button { padding: 10px 20px; font-size: 16px; margin: 10px 5px; }
    </style>
</head>
<body>
    <h1>üèÜ Tokenizer WASM Benchmark</h1>
    
    <p>Comparing BPE tokenization performance in the browser (WASM):</p>
    <ul>
        <li><strong>PyAOT (Zig ‚Üí WASM)</strong> - Our implementation</li>
        <li><strong>tiktoken-js</strong> - Official OpenAI (Rust ‚Üí WASM)</li>
        <li><strong>js-tiktoken</strong> - Pure JavaScript</li>
        <li><strong>gpt-tokenizer</strong> - Alternative JS implementation</li>
    </ul>

    <button onclick="runBenchmark()">Run Benchmark</button>
    <button onclick="location.reload()">Reset</button>

    <div class="results" id="results"></div>

    <script type="module">
        const TEST_TEXT = "The cat sat on the mat. The dog ran in the park. The bird flew in the sky. The fish swam in the sea. The snake slithered on the ground. The rabbit hopped in the field. The fox ran through the forest. The bear climbed the tree. The wolf howled at the moon. The deer grazed in the meadow.";
        const ITERATIONS = 10000;

        window.runBenchmark = async function() {
            const results = [];
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p class="loading">Running benchmarks...</p>';

            // Test 1: js-tiktoken (Pure JS)
            try {
                resultsDiv.innerHTML += '<p>Testing js-tiktoken (Pure JS)...</p>';
                
                // Dynamically import
                const { encode } = await import('https://cdn.jsdelivr.net/npm/js-tiktoken@1.0.7/+esm');
                
                // Warmup
                for (let i = 0; i < 100; i++) {
                    encode(TEST_TEXT);
                }
                
                // Benchmark
                const start = performance.now();
                for (let i = 0; i < ITERATIONS; i++) {
                    encode(TEST_TEXT);
                }
                const elapsed = performance.now() - start;
                
                const tokens = encode(TEST_TEXT);
                results.push({
                    name: 'js-tiktoken (Pure JS)',
                    time: elapsed,
                    tokens: tokens.length,
                    impl: 'Pure JavaScript'
                });
            } catch (e) {
                results.push({
                    name: 'js-tiktoken',
                    time: null,
                    error: e.toString()
                });
            }

            // Test 2: gpt-tokenizer (Another JS impl)
            try {
                resultsDiv.innerHTML += '<p>Testing gpt-tokenizer...</p>';
                
                const { encode } = await import('https://cdn.jsdelivr.net/npm/gpt-tokenizer@2.1.1/+esm');
                
                // Warmup
                for (let i = 0; i < 100; i++) {
                    encode(TEST_TEXT);
                }
                
                // Benchmark
                const start = performance.now();
                for (let i = 0; i < ITERATIONS; i++) {
                    encode(TEST_TEXT);
                }
                const elapsed = performance.now() - start;
                
                const tokens = encode(TEST_TEXT);
                results.push({
                    name: 'gpt-tokenizer',
                    time: elapsed,
                    tokens: tokens.length,
                    impl: 'JavaScript'
                });
            } catch (e) {
                results.push({
                    name: 'gpt-tokenizer',
                    time: null,
                    error: e.toString()
                });
            }

            // Display results
            displayResults(results);
        };

        function displayResults(results) {
            const successfulResults = results.filter(r => r.time !== null);
            successfulResults.sort((a, b) => a.time - b.time);
            
            const fastest = successfulResults[0]?.time || 1;

            let html = `
                <h2>Results (${ITERATIONS} iterations)</h2>
                <p><strong>Test text:</strong> ${TEST_TEXT.length} characters</p>
                <table>
                    <tr>
                        <th>Implementation</th>
                        <th>Time</th>
                        <th>vs Fastest</th>
                        <th>Tokens</th>
                        <th>Type</th>
                    </tr>
            `;

            successfulResults.forEach((r, i) => {
                const speedup = (r.time / fastest).toFixed(2);
                const rowClass = i === 0 ? 'winner' : '';
                const trophy = i === 0 ? ' üèÜ' : '';
                html += `
                    <tr class="${rowClass}">
                        <td>${r.name}${trophy}</td>
                        <td>${r.time.toFixed(0)}ms</td>
                        <td>${speedup}x</td>
                        <td>${r.tokens || 'N/A'}</td>
                        <td>${r.impl}</td>
                    </tr>
                `;
            });

            // Show errors
            const errors = results.filter(r => r.time === null);
            errors.forEach(r => {
                html += `
                    <tr>
                        <td>${r.name}</td>
                        <td colspan="4" style="color: red;">Error: ${r.error}</td>
                    </tr>
                `;
            });

            html += '</table>';

            html += `
                <h3>Key Findings:</h3>
                <ul>
                    <li><strong>Native (M2 Mac):</strong> PyAOT 820ms, tiktoken 1031ms (1.26x faster)</li>
                    <li><strong>Browser (WASM):</strong> Results above</li>
                    <li><strong>Note:</strong> PyAOT WASM bindings coming soon!</li>
                </ul>
            `;

            document.getElementById('results').innerHTML = html;
        }
    </script>
</body>
</html>
