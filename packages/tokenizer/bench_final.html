<!DOCTYPE html>
<html>
<head>
    <title>Tokenizer Benchmark - All 4</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        h1 { color: #4ec9b0; }
        table { border-collapse: collapse; margin: 20px 0; width: 100%; }
        th, td { border: 1px solid #3e3e42; padding: 12px; text-align: left; }
        th { background: #252526; font-weight: bold; }
        .winner { background: #1e3a20; font-weight: bold; }
        button { padding: 10px 20px; font-size: 16px; margin: 10px 0; background: #0e639c; color: white; border: none; cursor: pointer; }
        button:hover { background: #1177bb; }
        .loading { color: #4ec9b0; }
        .error { color: #f48771; }
        pre { background: #252526; padding: 10px; }
    </style>
</head>
<body>
    <h1>üèÜ Tokenizer Benchmark - All 4 (Bun IIFE)</h1>
    <p>10,000 iterations on 286-byte text</p>

    <button onclick="runBenchmark()">Run Benchmark</button>

    <div id="status"></div>
    <div id="results"></div>

    <script src="./dist/bench_gpt.js?v=2"></script>
    <script src="./dist/bench_tiktoken.js?v=2"></script>
    <script src="./dist/bench_ai.js?v=2"></script>

    <script>
        const TEXT = "The cat sat on the mat. The dog ran in the park. The bird flew in the sky. The fish swam in the sea. The snake slithered on the ground. The rabbit hopped in the field. The fox ran through the forest. The bear climbed the tree. The wolf howled at the moon. The deer grazed in the meadow.";
        const ITERATIONS = 10000;

        async function runBenchmark() {
            const results = [];
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');

            statusDiv.innerHTML = '<p class="loading">Running benchmarks...</p>';
            resultsDiv.innerHTML = '';

            // Test 1: gpt-tokenizer
            statusDiv.innerHTML += '<p>Testing gpt-tokenizer...</p>';
            try {
                const time = window.benchGPTTokenizer(TEXT, ITERATIONS);
                const tokens = window.testGPTTokenizer(TEXT);

                results.push({
                    name: 'gpt-tokenizer',
                    time: Math.round(time),
                    tokens: tokens,
                    type: 'Pure JS',
                    size: '1.1MB'
                });
            } catch (e) {
                results.push({ name: 'gpt-tokenizer', error: e.message });
            }

            // Test 2: tiktoken
            statusDiv.innerHTML += '<p>Testing tiktoken (Rust‚ÜíWASM)...</p>';
            try {
                await window.initTiktoken();
                const time = window.benchTiktoken(TEXT, ITERATIONS);
                const tokens = window.testTiktoken(TEXT);

                results.push({
                    name: 'tiktoken (Rust‚ÜíWASM)',
                    time: Math.round(time),
                    tokens: tokens,
                    type: 'WASM',
                    size: '5.6MB'
                });
                window.freeTiktoken();
            } catch (e) {
                results.push({ name: 'tiktoken', error: e.message });
            }

            // Test 3: ai-tokenizer
            statusDiv.innerHTML += '<p>Testing ai-tokenizer...</p>';
            try {
                console.log('window.benchAITokenizer:', typeof window.benchAITokenizer);
                if (!window.benchAITokenizer) throw new Error('benchAITokenizer not loaded');

                const time = window.benchAITokenizer(TEXT, ITERATIONS);
                const tokens = window.testAITokenizer(TEXT);

                results.push({
                    name: 'ai-tokenizer',
                    time: Math.round(time),
                    tokens: tokens,
                    type: 'Pure JS',
                    size: '8.6MB'
                });
            } catch (e) {
                results.push({ name: 'ai-tokenizer', error: e.message });
            }

            // Test 4: PyAOT WASM
            statusDiv.innerHTML += '<p>PyAOT WASM: Size only (needs tokenizer JSON)...</p>';
            results.push({
                name: 'PyAOT (Zig‚ÜíWASM)',
                error: 'Needs cl100k_base.json',
                size: '62KB'
            });

            // Display results
            displayResults(results);
            statusDiv.innerHTML = '<p class="loading">‚úÖ Complete!</p>';
        }

        function displayResults(results) {
            const successful = results.filter(r => !r.error).sort((a, b) => a.time - b.time);
            const fastest = successful[0]?.time || 1;

            let html = `
                <h2>Results (${ITERATIONS} iterations, ${TEXT.length}-byte text)</h2>
                <table>
                    <tr>
                        <th>Implementation</th>
                        <th>Time</th>
                        <th>vs Fastest</th>
                        <th>Size</th>
                        <th>Tokens</th>
                        <th>Type</th>
                    </tr>
            `;

            successful.forEach((r, i) => {
                const speedup = (r.time / fastest).toFixed(2);
                const rowClass = i === 0 ? 'winner' : '';
                const trophy = i === 0 ? ' üèÜ' : '';
                html += `
                    <tr class="${rowClass}">
                        <td>${r.name}${trophy}</td>
                        <td>${r.time}ms</td>
                        <td>${speedup}x</td>
                        <td>${r.size}</td>
                        <td>${r.tokens}</td>
                        <td>${r.type}</td>
                    </tr>
                `;
            });

            // Show errors
            const errors = results.filter(r => r.error);
            errors.forEach(r => {
                const sizeInfo = r.size ? ` (${r.size})` : '';
                html += `
                    <tr>
                        <td>${r.name}</td>
                        <td colspan="5" class="error">${r.error}${sizeInfo}</td>
                    </tr>
                `;
            });

            html += `</table>
                <h3>Native Comparison (60K iterations):</h3>
                <pre>PyAOT (Zig):      741ms üèÜ #1
TokenDagger (C):  775ms
tiktoken (Rust): 1194ms
HuggingFace:     5240ms</pre>
                <p><strong>Browser is ~6-8x slower than native</strong> (expected for WASM/JS overhead)</p>
            `;

            document.getElementById('results').innerHTML = html;
        }
    </script>
</body>
</html>
