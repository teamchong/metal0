.PHONY: help benchmark benchmark-train benchmark-encoding benchmark-web benchmark-json benchmark-quick test-correctness build build-wasm clean

# Colors for output
GREEN := \033[0;32m
YELLOW := \033[0;33m
BLUE := \033[0;34m
RESET := \033[0m

# Build flags
ZIG := zig
OPTIMIZE := -O ReleaseFast
BIN_DIR := zig-out/bin

# Default target - show help
help:
	@echo "$(BLUE)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(RESET)"
	@echo "$(GREEN)PyAOT Tokenizer Benchmarks$(RESET)"
	@echo "$(BLUE)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(RESET)"
	@echo ""
	@echo "$(GREEN)Available targets:$(RESET)"
	@echo "  make benchmark-quick    - โก Quick (3 libs, 100 iter, ~5s) - for rapid iteration"
	@echo "  make benchmark          - Run ALL benchmarks (train + encoding + web + json)"
	@echo "  make benchmark-train    - BPE training (3 libraries)"
	@echo "  make benchmark-encoding - Encoding (5 libraries w/ PyAOT, TokenDagger)"
	@echo "  make benchmark-web      - Web/WASM benchmark (4 libraries)"
	@echo "  make benchmark-json     - JSON parse+stringify (Zig vs Rust vs Python vs Go)"
	@echo "  make test-correctness   - Verify PyAOT matches tiktoken (583+ tests)"
	@echo ""
	@echo "$(GREEN)Build targets:$(RESET)"
	@echo "  make build              - Build all native binaries"
	@echo "  make build-wasm         - Build WASM tokenizer"
	@echo "  make clean              - Clean build artifacts"
	@echo ""

# Run all benchmarks (train + encoding + web + json)
benchmark: benchmark-train benchmark-encoding benchmark-web benchmark-json

# Training benchmarks (PyAOT vs HuggingFace vs SentencePiece)
benchmark-train:
	@echo "$(BLUE)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(RESET)"
	@echo "$(GREEN)๐ BPE Training Benchmark (hyperfine)$(RESET)"
	@echo "$(BLUE)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(RESET)"
	@echo ""
	@./bench_training.sh
	@echo ""

# Quick benchmark (PyAOT vs TokenDagger only - for fast iteration)
benchmark-quick: build
	@echo "$(BLUE)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(RESET)"
	@echo "$(GREEN)โก Quick Benchmark: PyAOT vs TokenDagger (hyperfine)$(RESET)"
	@echo "$(BLUE)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(RESET)"
	@echo ""
	@./bench_hyperfine.sh
	@echo ""

# Native encoding benchmarks (5 libraries: PyAOT, rs-bpe, tiktoken, TokenDagger, HuggingFace)
benchmark-encoding:
	@echo "$(BLUE)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(RESET)"
	@echo "$(GREEN)๐ Encoding Benchmark: 5 libraries$(RESET)"
	@echo "$(BLUE)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(RESET)"
	@echo ""
	@./BENCHMARK.sh
	@echo ""

# Test correctness (comprehensive: 583 benchmark texts + edge cases)
test-correctness: build
	@echo "$(BLUE)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(RESET)"
	@echo "$(GREEN)๐ Correctness Test (Comprehensive)$(RESET)"
	@echo "$(BLUE)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(RESET)"
	@echo ""
	@python3 test_comprehensive.py
	@echo ""

# Web/WASM benchmarks (hyperfine-based, Node.js)
benchmark-web: build-wasm
	@echo "$(BLUE)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(RESET)"
	@echo "$(GREEN)๐ Web/WASM Benchmark (hyperfine)$(RESET)"
	@echo "$(BLUE)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(RESET)"
	@echo ""
	@chmod +x bench_web.sh
	@./bench_web.sh
	@echo ""

# JSON parse+stringify benchmarks
benchmark-json:
	@echo "$(BLUE)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(RESET)"
	@echo "$(GREEN)๐ JSON Parse+Stringify Benchmark (hyperfine)$(RESET)"
	@echo "$(BLUE)โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ$(RESET)"
	@echo ""
	@chmod +x bench_json.sh
	@./bench_json.sh
	@echo ""

# Build all native binaries (no build.zig - direct zig commands)
build:
	@echo "$(YELLOW)๐จ Building native binaries...$(RESET)"
	@mkdir -p $(BIN_DIR)
	@$(ZIG) build-exe src/main.zig $(OPTIMIZE) -femit-bin=$(BIN_DIR)/tokenizer_bench
	@$(ZIG) build-exe src/bench_native.zig $(OPTIMIZE) -femit-bin=$(BIN_DIR)/bench_native
	@$(ZIG) build-exe src/bench_train.zig $(OPTIMIZE) -femit-bin=$(BIN_DIR)/bench_train
	@$(ZIG) build-exe src/test_correctness.zig $(OPTIMIZE) -femit-bin=$(BIN_DIR)/test_correctness
	@echo "$(GREEN)โ Build complete:$(RESET)"
	@echo "   - tokenizer_bench"
	@echo "   - bench_native"
	@echo "   - bench_train"
	@echo "   - test_correctness"
	@echo ""

# Build WASM tokenizer (direct zig command)
build-wasm:
	@echo "$(YELLOW)๐จ Building WASM tokenizer...$(RESET)"
	@mkdir -p dist
	@$(ZIG) build-exe src/wasm.zig \
		-target wasm32-freestanding \
		-fno-entry \
		-O ReleaseSmall \
		-rdynamic \
		-femit-bin=dist/pyaot_tokenizer.wasm
	@if [ ! -f dist/cl100k_simple.json ]; then \
		echo "$(YELLOW)โ๏ธ  cl100k_simple.json not found in dist/$(RESET)"; \
		echo "$(YELLOW)   Copy vocab file: cp vocab/cl100k_simple.json dist/$(RESET)"; \
		exit 1; \
	fi
	@echo "$(GREEN)โ WASM build complete$(RESET)"
	@echo ""

# Clean build artifacts
clean:
	@echo "$(YELLOW)๐งน Cleaning build artifacts...$(RESET)"
	@rm -rf zig-out/ zig-cache/ dist/*.wasm
	@rm -f bench_trainer bench_cl100k test_tokendagger
	@rm -f *.a *.o *.wasm
	@echo "$(GREEN)โ Clean complete$(RESET)"
